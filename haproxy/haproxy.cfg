global
    log stdout format raw local0
    maxconn 200000
    tune.bufsize 32768
    tune.maxrewrite 8192

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option forwardfor

    timeout connect 10s
    timeout client 300s
    timeout server 300s
    timeout tunnel 3600s
    timeout client-fin 30s
    timeout check 5s

# HAProxy stats
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE

# WebSocket frontend
frontend mining_ws
    bind *:85
    default_backend mining_proxies

# Mining proxy backend (WebSocket)
backend mining_proxies
    mode http
    balance roundrobin

    # REQUIRED for WebSocket
    option http-server-close
    option forwardfor

    # Health check
    option httpchk GET /health
    http-check expect status 200
    
    server proxy1 proxy1:8000 check inter 5s rise 2 fall 3 maxconn 50000
    server proxy2 proxy2:8000 check inter 5s rise 2 fall 3 maxconn 50000
    server proxy3 proxy3:8000 check inter 5s rise 2 fall 3 maxconn 50000
    server proxy4 proxy4:8000 check inter 5s rise 2 fall 3 maxconn 50000
