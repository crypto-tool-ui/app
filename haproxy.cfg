global
    log stdout format raw local0
    maxconn 200000
    # Performance tuning
    tune.bufsize 32768
    tune.maxrewrite 8192
    
defaults
    log global
    mode http
    option httplog
    option dontlognull
    option forwardfor
    
    # Timeouts for WebSocket
    timeout connect 10s
    timeout client 300s
    timeout server 300s
    timeout tunnel 3600s
    timeout client-fin 30s
    
    # Health check defaults
    timeout check 5s
    
# HAProxy stats interface
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE

# WebSocket frontend
frontend mining_ws
    bind *:80
    
    # ACL for health check
    acl is_health path /health
    
    # Use health check backend if requested
    use_backend health_check if is_health
    
    # Default to mining proxy pool
    default_backend mining_proxies

# Health check backend (any proxy node)
backend health_check
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    server proxy1 proxy1:8000 check inter 5s rise 2 fall 3
    server proxy2 proxy2:8000 check inter 5s rise 2 fall 3
    server proxy3 proxy3:8000 check inter 5s rise 2 fall 3
    server proxy4 proxy4:8000 check inter 5s rise 2 fall 3

# Mining proxy backend pool
backend mining_proxies
    mode tcp
    
    # Balance by source IP to maintain session affinity
    balance source
    
    # Enable WebSocket protocol upgrade
    option http-server-close
    option forceclose
    
    # Health check configuration
    option httpchk GET /health
    http-check expect status 200
    
    # Stick table for session persistence (24 hours)
    stick-table type ip size 1m expire 24h
    stick on src
    
    # Proxy servers
    server proxy1 proxy1:8000 check inter 5s rise 2 fall 3 maxconn 50000
    server proxy2 proxy2:8000 check inter 5s rise 2 fall 3 maxconn 50000
    server proxy3 proxy3:8000 check inter 5s rise 2 fall 3 maxconn 50000
    server proxy4 proxy4:8000 check inter 5s rise 2 fall 3 maxconn 50000
